{% extends "base.html" %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container">
  <a href="{% url 'products_category' product.category.slug %}" class="btn btn-sm mb-3" style="color: var(--nfc-teal); font-size: 1.5rem;">
    <i class="fa fa-arrow-left"></i> Back to {{ product.category.name }}
  </a>

  <div class="mt-4 slideIn from-left">
    <div class="row mb-4">
      <div class="col-12 text-left">
        <h1>{{ product.name }}</h1>
              
        <div class="product-gallery mt-3">
          <div class="main-image-container me-2">
            <button class="nav-arrow nav-prev" onclick="prevImage()">&#10094;</button>
            {% if product.images.exists %}
              {% with main_image=product.images.filter.first %}
                <img id="main-product-image" src="{{ main_image.image.url }}" alt="{{ product.name }}" class="img-fluid rounded" onclick="openLightbox(currentImageIndex)">
              {% endwith %}
            {% elif product.image %}
              <img id="main-product-image" src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded" onclick="openLightbox(currentImageIndex)">
            {% endif %}
            <button class="nav-arrow nav-next" onclick="nextImage()">&#10095;</button>
          </div>
          
          <div class="product-thumbnails">
            {% if product.image %}
              <div class="thumbnail-item mb-2">
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="thumbnail active" 
                    onclick="changeMainImage('{{ product.image.url }}', this)">
              </div>
            {% endif %}
            
            {% for img in product.images.all %}
              <div class="thumbnail-item mb-2">
                <img src="{{ img.image.url }}" alt="{{ img.title|default:product.name }}" class="thumbnail"
                    onclick="changeMainImage('{{ img.image.url }}', this)">
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Lightbox Modal -->
    <div id="image-lightbox" class="lightbox">
      <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
      <img class="lightbox-content" id="lightbox-img">
      <div class="lightbox-caption">{{ product.name }}</div>
      <button class="lightbox-nav lightbox-prev" onclick="lightboxPrev()">&#10094;</button>
      <button class="lightbox-nav lightbox-next" onclick="lightboxNext()">&#10095;</button>
    </div>
   
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let currentImageIndex = 0;
        
        const imageUrls = [];
        
        const thumbnailElements = document.querySelectorAll('.thumbnail');
        thumbnailElements.forEach(function(thumbnail) {
          imageUrls.push(thumbnail.getAttribute('src'));
        });
        
        window.currentImageIndex = currentImageIndex;
        window.imageUrls = imageUrls;
        
        function nextImage() {
          currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
          document.getElementById('main-product-image').src = imageUrls[currentImageIndex];
          
          updateActiveThumbnail();
          window.currentImageIndex = currentImageIndex;
        }
        
        function prevImage() {
          currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
          document.getElementById('main-product-image').src = imageUrls[currentImageIndex];
          
          updateActiveThumbnail();
          window.currentImageIndex = currentImageIndex;
        }
        
        function updateActiveThumbnail() {
          thumbnailElements.forEach((thumbnail, index) => {
            if (index === currentImageIndex) {
              thumbnail.classList.add('active');
            } else {
              thumbnail.classList.remove('active');
            }
          });
        }
        
        window.nextImage = nextImage;
        window.prevImage = prevImage;
        window.changeMainImage = function(url, clickedThumbnail) {
          document.getElementById('main-product-image').src = url;
          
          thumbnailElements.forEach(thumbnail => {
            thumbnail.classList.remove('active');
          });
          
          clickedThumbnail.classList.add('active');
          
          currentImageIndex = Array.from(thumbnailElements).indexOf(clickedThumbnail);
          window.currentImageIndex = currentImageIndex;
        };
        
        // Lightbox functionality
        window.openLightbox = function(imageIndex) {
          const lightbox = document.getElementById('image-lightbox');
          const lightboxImg = document.getElementById('lightbox-img');
          
          lightboxImg.src = imageUrls[imageIndex];
          lightbox.style.display = 'block';
          
          // Prevent scrolling on body
          document.body.style.overflow = 'hidden';
        };
        
        window.closeLightbox = function() {
          document.getElementById('image-lightbox').style.display = 'none';
          
          // Re-enable scrolling on body
          document.body.style.overflow = 'auto';
        };
        
        window.lightboxNext = function() {
          currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
          document.getElementById('lightbox-img').src = imageUrls[currentImageIndex];
          window.currentImageIndex = currentImageIndex;
          updateActiveThumbnail();
        };
        
        window.lightboxPrev = function() {
          currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
          document.getElementById('lightbox-img').src = imageUrls[currentImageIndex];
          window.currentImageIndex = currentImageIndex;
          updateActiveThumbnail();
        };
        
        // Close lightbox when clicking outside the image
        document.getElementById('image-lightbox').addEventListener('click', function(event) {
          if (event.target === this) {
            closeLightbox();
          }
        });
        
        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(event) {
          if (document.getElementById('image-lightbox').style.display === 'block') {
            if (event.key === 'Escape') {
              closeLightbox();
            } else if (event.key === 'ArrowRight') {
              lightboxNext();
            } else if (event.key === 'ArrowLeft') {
              lightboxPrev();
            }
          }
        });
        
        const firstThumbnail = document.querySelector('.thumbnail');
        if (firstThumbnail) {
          firstThumbnail.classList.add('active');
        }
      });
    </script>
  </div>
    
  <div class="row justify-content-left">
    <div class="col-lg-10">
      <div class="description-container mb-5">
        {{ product.description|safe }}
      </div>
    </div>
     

    {% if product.files.all %}
    <div class="border-top pt-4 mb-5">
      <h3 class="h5 mb-3">Documentation</h3>
      <ul class="list-unstyled">
        {% for file in product.files.all %}
          <li class="mb-3">
            {% with file_ext=file.file.name|slice:"-3:" %}
              <a href="{{ file.file.url }}" class="button-slide" download>
                <span class="button-slide-decor"></span>
                <span class="button-slide-content">
                  <span class="button-slide__icon">
                    {% if file_ext == 'pdf' %}
                      <i class="bi bi-file-earmark-pdf file-icon-pdf"></i>
                    {% elif file_ext == 'xls' or file_ext == 'lsx' %}
                      <i class="bi bi-file-earmark-excel file-icon-excel"></i>
                    {% elif file_ext == 'doc' or file_ext == 'ocx' %}
                      <i class="bi bi-file-earmark-word file-icon-word"></i>
                    {% elif file_ext == 'ppt' or file_ext == 'ptx' %}
                      <i class="bi bi-file-earmark-ppt file-icon-ppt"></i>
                    {% elif file_ext == 'txt' %}
                      <i class="bi bi-file-earmark-text file-icon-text"></i>
                    {% elif file_ext == 'zip' or file_ext == 'rar' %}
                      <i class="bi bi-file-earmark-zip file-icon-zip"></i>
                    {% elif file_ext == 'png' or file_ext == 'jpg' or file_ext == 'jpeg' or file_ext == 'gif' %}
                      <i class="bi bi-file-earmark-image file-icon-image"></i>
                    {% elif file_ext == 'csv' %}
                      <i class="bi bi-file-earmark-spreadsheet file-icon-spreadsheet"></i>
                    {% else %}
                      <i class="bi bi-file-earmark file-icon-default"></i>
                    {% endif %}
                  </span>
                  <span class="button-slide__text">{{ file.title|default:"Download File" }}</span>
                </span>
              </a>
            {% endwith %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <div class="card border-0 shadow-sm mb-5">
      <div class="card-body p-4">
        <h2 class="h4 mb-4">Inquire about {{ product.name }}</h2>
        <form id="productContactForm" method="post" action="{% url 'product_detail' slug=product.slug %}">
          {% csrf_token %}
          <input type="hidden" name="product_interest" value="{{ product.name }}">
          <div class="row g-3">
            <div class="col-12">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="col-12">
              <label for="message" class="form-label">Message *</label>
              <textarea class="form-control" id="message" name="message" rows="5" required></textarea>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="privacy" name="privacy" required>
                <label class="form-check-label" for="privacy">
                  I agree to the processing of my personal data in accordance with the privacy policy
                </label>
              </div>
            </div>
            <div class="col-12 mt-3">
              <div id="recaptcha-container"></div>
              <small class="text-muted">Please complete the CAPTCHA to verify you're not a robot</small>
            </div>
            <div class="col-12 mt-4">
              <button type="submit" class="btn btn-primary w-100" style="background-color: var(--nfc-teal); border-color: var(--nfc-teal);">Send Message</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}