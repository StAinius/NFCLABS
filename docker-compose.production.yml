services:
 web:
   build: .
   ports:
     - "8000:8000"
   volumes:
     - ./db.sqlite3:/app/db.sqlite3
     - media_volume:/app/media
     - static_volume:/app/staticfiles
   environment:
     - DEBUG=False
     - ALLOWED_HOSTS=nfclabs.com,www.nfclabs.com,89.40.6.100
   command: gunicorn NFCLabs.wsgi:application --bind 0.0.0.0:8000
 
 nginx:
   image: nginx:alpine
   ports:
     - "80:80"
     - "443:443"
   volumes:
     - ./nginx.conf:/etc/nginx/conf.d/default.conf
     - /etc/letsencrypt:/etc/letsencrypt:ro
     - static_volume:/app/staticfiles:ro
     - media_volume:/app/media:ro
   depends_on:
     - web
   command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
 
 certbot:
   image: certbot/certbot
   volumes:
     - ./certbot/conf:/etc/letsencrypt
     - ./certbot/www:/var/www/certbot
   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  static_volume:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/var/www/nfclabs_static'
  media_volume:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '/var/www/nfclabs_media'